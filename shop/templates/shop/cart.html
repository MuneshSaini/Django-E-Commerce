{% extends "shop/base.html" %}

{% block title %}Your Shopping Cart{% endblock %}

{% block content %}
<h2>Your Shopping Cart</h2>
<div class="cart-layout">
    <div class="cart-items">
        {% if cart %}
            {% for item in cart %}
                <div class="cart-item" data-product-id="{{ item.product.id }}">
                    <div class="cart-item-image">
                        {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                        {% else %}
                            <div class="image-placeholder">No Image</div>
                        {% endif %}
                    </div>
                    <div class="cart-item-details">
                        <h3>{{ item.product.name }}</h3>
                        <p class="price">Unit Price: ${{ item.price }}</p>
                        <p class="price">Total: <span class="item-total-price">${{ item.total_price|floatformat:2 }}</span></p>
                    </div>
                    <div class="cart-item-actions">
                        <form action="{% url 'shop:update_cart' item.product.id %}" method="post" class="quantity-form">
                            {% csrf_token %}
                            <div class="quantity-widget">
                                <button type="button" class="quantity-btn minus" aria-label="Decrease quantity">-</button>
                                <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" class="quantity-input">
                                <button type="button" class="quantity-btn plus" aria-label="Increase quantity">+</button>
                            </div>
                        </form>
                        <a href="{% url 'shop:remove_from_cart' item.product.id %}" class="btn btn-danger btn-sm">Remove</a>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-cart-message">
                <h3>Your cart is empty.</h3>
                <p>Looks like you haven't added anything to your cart yet.</p>
                <br>
                <a href="{% url 'shop:product_list' %}" class="btn btn-primary">Start Shopping</a>
            </div>
        {% endif %}
    </div>

    {% if cart %}
    <div class="cart-summary-card">
        <h3>Order Summary</h3>
        <div class="summary-row">
            <span>Subtotal</span>
            <strong id="cart-subtotal">${{ cart.get_total_price|floatformat:2 }}</strong>
        </div>
        <div class="summary-row">
            <span>Shipping</span>
            <strong>FREE</strong>
        </div>
        <hr>
        <div class="summary-row total">
            <span>Total</span>
            <strong id="cart-total">${{ cart.get_total_price|floatformat:2 }}</strong>
        </div>
        <form action="{% url 'shop:checkout' %}" method="post" class="checkout-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-full">Proceed to Checkout</button>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const forms = document.querySelectorAll('.quantity-form');
    let debounceTimer;

    function sendUpdateRequest(form, newQuantity) {
        if (newQuantity < 1) return;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const formData = new FormData(form);
            formData.set('quantity', newQuantity);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
            })
            .then(response => {
                if (!response.ok) { throw new Error('Network response was not ok'); }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('cart-subtotal').textContent = `$${parseFloat(data.cart_total_price).toFixed(2)}`;
                    document.getElementById('cart-total').textContent = `$${parseFloat(data.cart_total_price).toFixed(2)}`;
                    document.getElementById('cart-count').textContent = data.cart_total_items;
                    const itemElement = form.closest('.cart-item');
                    const itemTotalPriceElement = itemElement.querySelector('.item-total-price');
                    itemTotalPriceElement.textContent = `$${parseFloat(data.item_total_price).toFixed(2)}`;
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }, 350);
    }
    forms.forEach(form => {
        const minusBtn = form.querySelector('.quantity-btn.minus');
        const plusBtn = form.querySelector('.quantity-btn.plus');
        const input = form.querySelector('.quantity-input');
        minusBtn.addEventListener('click', () => {
            let currentValue = parseInt(input.value, 10);
            if (currentValue > 1) {
                input.value = currentValue - 1;
                sendUpdateRequest(form, input.value);
            }
        });
        plusBtn.addEventListener('click', () => {
            let currentValue = parseInt(input.value, 10);
            const maxStock = parseInt(input.getAttribute('max'), 10);
            if (currentValue < maxStock) {
                input.value = currentValue + 1;
                sendUpdateRequest(form, input.value);
            }
        });
        input.addEventListener('change', () => { sendUpdateRequest(form, input.value); });
    });
});
</script>
{% endblock %}